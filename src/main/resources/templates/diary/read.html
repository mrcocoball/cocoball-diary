<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic2.html}">

<div layout:fragment="content">

  <div class="container-write">
    <div class="py-5 text-center">
      <p class="lead">장소명과 주소를 입력하고 리뷰, 사진을 올려주세요!</p>
    </div>

    <div class="row g-5">
      <div class="col-md-5 col-lg-4 order-md-last">
        <h4 class="d-flex justify-content-between align-items-center mb-3">
          <span class="text">장소 정보</span>
        </h4>
        <ul class="list-group mb-3">
          <li class="list-group-item">
            <div>
              <h6 class="my-0">장소명</h6>
              <input type="text" class="form-control" placeholder="장소명" readonly>
            </div>
          </li>
          <li class="list-group-item">
            <div>
              <h6 class="my-0">주소</h6>
              <input type="text" class="form-control" placeholder="주소" readonly>
            </div>
          </li>
          <li class="list-group-item" id="place-star">
            <div>
              <h6 class="my-0">평점</h6>
              <fieldset>
                <input type="radio" name="score" value=5 id="rate1" th:checked="${dto.score eq 5}"
                       onclick="return(false)"><label for="rate1">★</label></input>
                <input type="radio" name="score" value=4 id="rate2" th:checked="${dto.score eq 4}"
                       onclick="return(false)"><label for="rate2">★</label></input>
                <input type="radio" name="score" value=3 id="rate3" th:checked="${dto.score eq 3}"
                       onclick="return(false)"><label for="rate3">★</label></input>
                <input type="radio" name="score" value=2 id="rate4" th:checked="${dto.score eq 2}"
                       onclick="return(false)"><label for="rate4">★</label></input>
                <input type="radio" name="score" value=1 id="rate5" th:checked="${dto.score eq 1}"
                       onclick="return(false)"><label for="rate5">★</label></input>
              </fieldset>
            </div>
          </li>
        </ul>
      </div>

      <div class="col-md-7 col-lg-8">
        <h4 class="mb-3">게시글 정보</h4>
        <div class="row g-3">
          <div class="col-12">
            <label for="title" class="form-label">제목</label>
            <input type="text" class="form-control" name="title" id="title" placeholder="" th:value="${dto.title}"
                   readonly>
            <div class="invalid-feedback">
              제목을 적어주세요.
            </div>
          </div>

          <div class="col-12">
            <span class="input-group-text">사진</span>
          </div>

          <div class="col-12">
            <label for="descripiton" class="form-label">내용</label>
            <textarea class="form-control" name="description" id="descripiton" rows="5" placeholder="" value=""
                      readonly>[[${dto.description}]]</textarea>
            <div class="invalid-feedback">
              내용을 적어주세요.
            </div>
          </div>

          <div class="col-12">
            <label for="uid" class="form-label">작성자</label>
            <input type="text" class="form-control" name="uid" id="uid" placeholder=""
                   th:value="${dto.uid}" readonly>
          </div>

          <div class="col-12" th:with="user=${#authentication.principal}">
            <div class="float-end" th:with="link = ${pageRequestDto.getLink()}">
              <a th:if="${user != null && user.username == dto.uid}"
                 th:href="|@{/diary/modify(aid=${dto.aid})}&${link}|" class="text-decoration-none">
                <button type="button" class="btn btn-secondary">게시글 수정</button>
              </a>
              <a th:if="${user != null && user.username == dto.uid}">
                <button type="button" class="btn btn-danger deleteBtn">게시글 삭제</button>
              </a>
              <a th:href="|@{/diary/list}?${link}|" class="text-decoration-none">
                <button type="button" class="btn btn-primary">게시글 목록으로</button>
              </a>
              <button class="btn btn-info addCommentBtn">덧글 작성</button>
            </div>
          </div>

          <div class="col-12">
            <div class="col-md-12">
              <ul class="list-group commentList">
              </ul>
            </div>
          </div>
          <div class="col-12">
            <div class="col">
              <ul class="pagination commentPaging">
              </ul>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- modal -->

  <!-- write modal -->
  <div class="modal writeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">덧글 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <span class="input-group-text">덧글 내용</span>
            <input type="text" class="form-control commentDescription">
          </div>
          <div class="input-group mb-3" th:with="user=${#authentication.principal}">
            <span class="input-group-text">작성자</span>
            <input type="text" class="form-control commentUid" th:value="${user.username}" readonly>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary writeBtn">등록</button>
          <button type="button" class="btn btn-outline-dark closeWriteBtn">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- modify modal -->
  <div class="modal modifyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title commentHeader"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <span class="input-group-text">덧글 내용</span>
            <input type="text" class="form-control modify-comment-description">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-info modifyBtn">수정</button>
          <button type="button" class="btn btn-danger removeBtn">삭제</button>
          <button type="button" class="btn btn-outline-dark closeModifyBtn">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- end of modal -->

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script src="/js/comment.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>

  <script layout:fragment="script" th:inline="javascript">

      const aid = [[${dto.aid}]]
      const link = [[${pageRequestDto.getLink()}]]

      // 덧글 관련 처리
      const commentList = document.querySelector('.commentList') //댓글 목록 DOM
      const commentPaging = document.querySelector('.commentPaging') //페이지 목록 DOM

      // 초기 화면 로딩 시
      window.onload = function(){

          printReplies(1, 10, true)

      }

      // 게시글 삭제
      document.querySelector(".deleteBtn").addEventListener("click", function (e) {
        e.preventDefault()
        e.stopPropagation()

        $.post('/diary/delete', {aid : aid})

        alert("게시글이 삭제되었습니다.")

        $.get('/diary/list')

        location.href = "/diary/list"

      }, false)

      // 덧글 목록
      function printList(dtoList) {
          let str = '';

          if (dtoList && dtoList.length > 0) {

              for (const dto of dtoList) {

                  str += `<li class="list-group-item d-flex commentItem">
                           <span class="col-2">${dto.cid}</span>
                           <span class="col-6" data-cid="${dto.cid}">${dto.commentDescription}</span>
                           <span class="col-2">${dto.commentUid}</span>
                           <span class="col-2">${dto.createdAt} </span>
                         </li>`
              }
          }
          commentList.innerHTML = str
      }

      //페이지 버튼 출력
      function printPages(data) {

          //pagination
          let pageStr = '';

          if (data.prev) {
              pageStr += `<li class="page-item"><a class="page-link" data-page="${data.start - 1}">PREV</a></li>`
          }

          for (let i = data.start; i <= data.end; i++) {
              pageStr += `<li class="page-item ${i == data.page ? "active" : ""} "><a class="page-link" data-page="${i}">${i}</a></li>`
          }

          if (data.next) {
              pageStr += `<li class="page-item"><a class="page-link" data-page="${data.end + 1}">NEXT</a></li>`
          }

          commentPaging.innerHTML = pageStr
      }

      // 덧글 리스트 + 페이지 버튼 출력
      function printReplies(page, size, goLast) {

          getList({aid, page, size, goLast}).then(
              data => {
                  printList(data.dtoList) //목록 처리
                  printPages(data) //페이지 처리
              }
          ).catch(e => {
              console.error(e)
          })

      }

      //댓글 등록 관련
      const writeModal = new bootstrap.Modal(document.querySelector(".writeModal"))
      //registerModel
      const writeBtn = document.querySelector(".writeBtn")
      const commentDescription = document.querySelector(".commentDescription")
      const commentUid = document.querySelector(".commentUid")
      const closeWriteBtn = document.querySelector(".closeWriteBtn")

      // 댓글 등록 버튼 클릭 시 댓글 등록 모달 표시
      document.querySelector(".addCommentBtn").addEventListener("click", function (e){
          console.log("모달 출력")
          writeModal.show()
      },false)

      // 댓글 등록 취소 버튼 클릭 시 모달 숨기기
      closeWriteBtn.addEventListener("click", function (e){
          console.log("모달 숨기기")
          writeModal.hide()
      },false)

      // 등록 버튼 클릭 시
      writeBtn.addEventListener("click", function(e){
          const commentObj = {
              aid:aid,
              commentDescription:commentDescription.value,
              commentUid:commentUid.value}

          addComment(commentObj).then(result => {
              alert(result.cid)
              writeModal.hide()
              commentDescription.value = ''
              commentUid.value =''
              printReplies(1,10, true) //댓글 목록 갱신
          }).catch(e => {
              alert("Exception...")
          })
      }, false)


      let page = 1
      let size = 10

      // 덧글 리스트 페이징 갱신
      commentPaging.addEventListener("click", function (e){

          e.preventDefault()
          e.stopPropagation()

          const target = e.target

          if(!target || target.tagName != 'A'){
              return
          }

          const pageNum = target.getAttribute("data-page")
          page = pageNum
          printReplies(page, size)

      },false)


  </script>